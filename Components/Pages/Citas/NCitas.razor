@page "/agregar/cita"
@rendermode InteractiveServer
@inject NavigationManager Navigation
@inject DatabaseService Db

<div class="top-row px-4">
    <h4 class="m-0">Nueva Cita</h4>
</div>

<article class="m-4">
    <EditForm class="mb-5" Model="_cita" FormName="frmCita" OnValidSubmit="Agregar" autocomplete="off">
        <DataAnnotationsValidator />

        <div class="input-group mb-3">
            <label class="input-group-text">Paciente</label>
            <InputSelect TValue="string" @bind-Value="_cita.IdPaciente" class="form-control">
                <option value="">-- Seleccione paciente --</option>
                @foreach (var paciente in _pacientes)
                {
                    <option value="@paciente.IdPaciente">@paciente.NombreCompleto</option>
                }
            </InputSelect>
        </div>
        <ValidationMessage For="@(() => _cita.IdPaciente)" />
        <br />

        <div class="input-group mb-3">
            <label class="input-group-text">Médico</label>
            <InputSelect TValue="string" @bind-Value="_cita.IdMedico" class="form-control">
                <option value="">-- Seleccione médico --</option>
                @foreach (var medico in _medicos)
                {
                    <option value="@medico.IdMedico">@medico.NombreCompleto</option>
                }
            </InputSelect>
        </div>
        <ValidationMessage For="@(() => _cita.IdMedico)" />
        <br />

        <div class="input-group mb-3">
            <label class="input-group-text">Fecha</label>
            <InputDate TValue="DateTime" @bind-Value="_cita.FechaCita" class="form-control" />
        </div>
        <ValidationMessage For="@(() => _cita.FechaCita)" />
        <br />

        <div class="input-group mb-3">
            <label class="input-group-text">Hora</label>
            <InputText type="time" @bind-Value="_horaInicioString" class="form-control" />
        </div>
        <ValidationMessage For="@(() => _cita.HoraInicio)" />
        <br />

        <div class="input-group mb-3">
            <label class="input-group-text">Estado</label>
            <InputSelect TValue="string" @bind-Value="_cita.Estado" class="form-control">
                <option value="pendiente">Pendiente</option>
                <option value="confirmada">Confirmada</option>
                <option value="cancelada">Cancelada</option>
                <option value="completada">Completada</option>
            </InputSelect>
        </div>
        <br />

        <button type="button" class="btn btn-secondary" @onclick="@(() => Navigation.NavigateTo("/citas"))">
            Cancelar
        </button>
        <button type="submit" class="btn btn-success ms-2">
            Agregar
        </button>
    </EditForm>
</article>

@code {
    private List<Paciente> _pacientes = new();
    private List<Medico> _medicos = new();
    private Cita _cita = new();

    private string _horaInicioString
    {
        get => _cita.HoraInicio.ToString(@"hh\:mm");
        set
        {
            if (TimeSpan.TryParse(value, out var ts))
                _cita.HoraInicio = ts;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var pacientesRaw = await Db.QueryAsync("SELECT id_paciente, nombre_completo FROM Pacientes");
        _pacientes = pacientesRaw
            .Select(p => new Paciente
                {
                    IdPaciente = p["id_paciente"]?.ToString() ?? "",
                    NombreCompleto = p["nombre_completo"]?.ToString() ?? ""
                })
            .ToList();

        var medicosRaw = await Db.QueryAsync("SELECT id_medico, nombre_completo FROM Medicos");
        _medicos = medicosRaw
            .Select(m => new Medico
                {
                    IdMedico = m["id_medico"]?.ToString() ?? "",
                    NombreCompleto = m["nombre_completo"]?.ToString() ?? ""
                })
            .ToList();
    }

    private async Task Agregar()
    {
        const string sql = @"
            INSERT INTO Citas
                (id_paciente, id_medico, fecha_cita, hora_inicio, estado)
            VALUES
                (@id_paciente, @id_medico, @fecha_cita, @hora_inicio, @estado)";

        var parametros = new Dictionary<string, object>
            {
                ["@id_paciente"] = _cita.IdPaciente,
                ["@id_medico"] = _cita.IdMedico,
                ["@fecha_cita"] = _cita.FechaCita,
                ["@hora_inicio"] = _cita.HoraInicio,
                ["@estado"] = _cita.Estado
            };

        await Db.ExecuteAsync(sql, parametros);
        Navigation.NavigateTo("/citas");
    }
}
